/********************************************************************************* 
* Ephesoft is a Intelligent Document Capture and Mailroom Automation program 
* developed by Ephesoft, Inc. Copyright (C) 2010-2011 Ephesoft Inc. 
* 
* This program is free software; you can redistribute it and/or modify it under 
* the terms of the GNU Affero General Public License version 3 as published by the 
* Free Software Foundation with the addition of the following permission added 
* to Section 15 as permitted in Section 7(a): FOR ANY PART OF THE COVERED WORK 
* IN WHICH THE COPYRIGHT IS OWNED BY EPHESOFT, EPHESOFT DISCLAIMS THE WARRANTY 
* OF NON INFRINGEMENT OF THIRD PARTY RIGHTS. 
* 
* This program is distributed in the hope that it will be useful, but WITHOUT 
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS 
* FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more 
* details. 
* 
* You should have received a copy of the GNU Affero General Public License along with 
* this program; if not, see http://www.gnu.org/licenses or write to the Free 
* Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 
* 02110-1301 USA. 
* 
* You can contact Ephesoft, Inc. headquarters at 111 Academy Way, 
* Irvine, CA 92617, USA. or at email address info@ephesoft.com. 
* 
* The interactive user interfaces in modified source and object code versions 
* of this program must display Appropriate Legal Notices, as required under 
* Section 5 of the GNU Affero General Public License version 3. 
* 
* In accordance with Section 7(b) of the GNU Affero General Public License version 3, 
* these Appropriate Legal Notices must retain the display of the "Ephesoft" logo. 
* If the display of the logo is not reasonably feasible for 
* technical reasons, the Appropriate Legal Notices must display the words 
* "Powered by Ephesoft". 
********************************************************************************/ 

/********************************************************************************* 
* Ephesoft is a Intelligent Document Capture and Mailroom Automation program 
* developed by Ephesoft, Inc. Copyright (C) 2010-2011 Ephesoft Inc. 
* 
* This program is free software; you can redistribute it and/or modify it under 
* the terms of the GNU Affero General Public License version 3 as published by the 
* Free Software Foundation with the addition of the following permission added 
* to Section 15 as permitted in Section 7(a): FOR ANY PART OF THE COVERED WORK 
* IN WHICH THE COPYRIGHT IS OWNED BY EPHESOFT, EPHESOFT DISCLAIMS THE WARRANTY 
* OF NON INFRINGEMENT OF THIRD PARTY RIGHTS. 
* 
* This program is distributed in the hope that it will be useful, but WITHOUT 
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS 
* FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more 
* details. 
* 
* You should have received a copy of the GNU Affero General Public License along with 
* this program; if not, see http://www.gnu.org/licenses or write to the Free 
* Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 
* 02110-1301 USA. 
* 
* You can contact Ephesoft, Inc. headquarters at 111 Academy Way, 
* Irvine, CA 92617, USA. or at email address info@ephesoft.com. 
* 
* The interactive user interfaces in modified source and object code versions 
* of this program must display Appropriate Legal Notices, as required under 
* Section 5 of the GNU Affero General Public License version 3. 
* 
* In accordance with Section 7(b) of the GNU Affero General Public License version 3, 
* these Appropriate Legal Notices must retain the display of the "Ephesoft" logo. 
* If the display of the logo is not reasonably feasible for 
* technical reasons, the Appropriate Legal Notices must display the words 
* "Powered by Ephesoft". 
********************************************************************************/ 

/********************************************************************************* 
* Ephesoft is a Intelligent Document Capture and Mailroom Automation program 
* developed by Ephesoft, Inc. Copyright (C) 2010-2011 Ephesoft Inc. 
* 
* This program is free software; you can redistribute it and/or modify it under 
* the terms of the GNU Affero General Public License version 3 as published by the 
* Free Software Foundation with the addition of the following permission added 
* to Section 15 as permitted in Section 7(a): FOR ANY PART OF THE COVERED WORK 
* IN WHICH THE COPYRIGHT IS OWNED BY EPHESOFT, EPHESOFT DISCLAIMS THE WARRANTY 
* OF NON INFRINGEMENT OF THIRD PARTY RIGHTS. 
* 
* This program is distributed in the hope that it will be useful, but WITHOUT 
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS 
* FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more 
* details. 
* 
* You should have received a copy of the GNU Affero General Public License along with 
* this program; if not, see http://www.gnu.org/licenses or write to the Free 
* Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 
* 02110-1301 USA. 
* 
* You can contact Ephesoft, Inc. headquarters at 111 Academy Way, 
* Irvine, CA 92617, USA. or at email address info@ephesoft.com. 
* 
* The interactive user interfaces in modified source and object code versions 
* of this program must display Appropriate Legal Notices, as required under 
* Section 5 of the GNU Affero General Public License version 3. 
* 
* In accordance with Section 7(b) of the GNU Affero General Public License version 3, 
* these Appropriate Legal Notices must retain the display of the "Ephesoft" logo. 
* If the display of the logo is not reasonably feasible for 
* technical reasons, the Appropriate Legal Notices must display the words 
* "Powered by Ephesoft". 
********************************************************************************/ 

/********************************************************************************* 
* Ephesoft is a Intelligent Document Capture and Mailroom Automation program 
* developed by Ephesoft, Inc. Copyright (C) 2010-2011 Ephesoft Inc. 
* 
* This program is free software; you can redistribute it and/or modify it under 
* the terms of the GNU Affero General Public License version 3 as published by the 
* Free Software Foundation with the addition of the following permission added 
* to Section 15 as permitted in Section 7(a): FOR ANY PART OF THE COVERED WORK 
* IN WHICH THE COPYRIGHT IS OWNED BY EPHESOFT, EPHESOFT DISCLAIMS THE WARRANTY 
* OF NON INFRINGEMENT OF THIRD PARTY RIGHTS. 
* 
* This program is distributed in the hope that it will be useful, but WITHOUT 
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS 
* FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more 
* details. 
* 
* You should have received a copy of the GNU Affero General Public License along with 
* this program; if not, see http://www.gnu.org/licenses or write to the Free 
* Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 
* 02110-1301 USA. 
* 
* You can contact Ephesoft, Inc. headquarters at 111 Academy Way, 
* Irvine, CA 92617, USA. or at email address info@ephesoft.com. 
* 
* The interactive user interfaces in modified source and object code versions 
* of this program must display Appropriate Legal Notices, as required under 
* Section 5 of the GNU Affero General Public License version 3. 
* 
* In accordance with Section 7(b) of the GNU Affero General Public License version 3, 
* these Appropriate Legal Notices must retain the display of the "Ephesoft" logo. 
* If the display of the logo is not reasonably feasible for 
* technical reasons, the Appropriate Legal Notices must display the words 
* "Powered by Ephesoft". 
********************************************************************************/ 

package com.ephesoft.dcma.gwt.reporting.server;

import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Set;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.ephesoft.dcma.core.DCMAException;
import com.ephesoft.dcma.core.common.Order;
import com.ephesoft.dcma.core.common.WorkflowType;
import com.ephesoft.dcma.da.domain.BatchClass;
import com.ephesoft.dcma.da.service.BatchClassService;
import com.ephesoft.dcma.gwt.core.server.DCMARemoteServiceServlet;
import com.ephesoft.dcma.gwt.core.shared.ReportDTO;
import com.ephesoft.dcma.gwt.core.shared.exception.GWTException;
import com.ephesoft.dcma.gwt.reporting.client.ReportingModelService;
import com.ephesoft.dcma.gwt.reporting.client.i18n.ReportingConstants;
import com.ephesoft.dcma.performance.reporting.domain.ReportDisplayData;
import com.ephesoft.dcma.performance.reporting.service.ReportDataService;
import com.ephesoft.dcma.util.ApplicationConfigProperties;
import com.ephesoft.dcma.util.OSUtil;

/**
 * The server side implementation for the calls coming from client side.
 * 
 * @author Ephesoft
 * 
 */
public class ReportingServiceImpl extends DCMARemoteServiceServlet implements ReportingModelService {

	/**
	 *Serial version id.
	 */
	private static final long serialVersionUID = 263606265567100312L;

	/**
	 * The path where the ant is placed.
	 */
	public static final String ANT_HOME_PATH = "ANT_HOME_PATH";

	protected final Logger log = LoggerFactory.getLogger(this.getClass());

	@Override
	public List<Integer> getSystemStatistics(Date startDate, Date endDate) throws GWTException {
		List<Integer> statistics = new ArrayList<Integer>();
		ReportDataService reportDataService = this.getSingleBeanOfType(ReportDataService.class);
		try {
			statistics = reportDataService.getSystemStatistics(endDate, startDate);
		} catch (DCMAException dcmae) {
			throw new GWTException("Exception while Getting System Statistics." + dcmae);
		}
		return statistics;
	}

	@Override
	public List<ReportDTO> getTableData(List<String> batchClassIds, WorkflowType workflowType, Date startDate, Date endDate,
			int startIndex, int maxResults, Order order) throws GWTException {
		ReportDataService reportDataService = this.getSingleBeanOfType(ReportDataService.class);
		List<ReportDisplayData> reports = new ArrayList<ReportDisplayData>();
		try {
			reports = reportDataService.getReportByWorkflow(batchClassIds, workflowType, endDate, startDate, startIndex, maxResults,
					order);
		} catch (DCMAException dcmae) {
			throw new GWTException("Exception while Getting Table Data." + dcmae);
		}
		List<ReportDTO> reportDtos = createReportDTOs(reports);
		return reportDtos;
	}

	@Override
	public List<ReportDTO> getTableDataForUser(List<String> batchClassIds, String user, Date startDate, Date endDate, int startIndex,
			int maxResults, Order order) throws GWTException {
		ReportDataService reportDataService = this.getSingleBeanOfType(ReportDataService.class);
		List<ReportDisplayData> reports = new ArrayList<ReportDisplayData>();
		try {
			reports = reportDataService.getReportByUser(batchClassIds, user, endDate, startDate, startIndex, maxResults, order);
		} catch (DCMAException dcmae) {
			throw new GWTException("Exception while Getting table Data for User." + dcmae);
		}
		List<ReportDTO> reportDtos = createReportDTOs(reports);
		return reportDtos;
	}

	@Override
	public HashMap<String, String> getAllBatchClasses() {
		BatchClassService batchClassService = this.getSingleBeanOfType(BatchClassService.class);
		List<BatchClass> batchClassList = batchClassService.getAllBatchClasses();
		LinkedHashMap<String, String> batchClassNames = new LinkedHashMap<String, String>();
		batchClassNames.put(ReportingConstants.ALL_TEXT, ReportingConstants.ALL_TEXT);
		for (Iterator<BatchClass> iterator = batchClassList.iterator(); iterator.hasNext();) {
			BatchClass batchClass = (BatchClass) iterator.next();
			batchClassNames.put(batchClass.getIdentifier(), batchClass.getIdentifier() + " - " + batchClass.getDescription());
		}
		return batchClassNames;
	};

	@Override
	public List<String> getAllUsers() {
		Set<String> usersSet = getAllUser();
		List<String> usersList = new ArrayList<String>();
		usersList.add(ReportingConstants.ALL_TEXT);
		usersList.addAll(usersSet);
		return usersList;
	}

	private List<ReportDTO> createReportDTOs(List<ReportDisplayData> reports) {
		List<ReportDTO> reportDTOs = new ArrayList<ReportDTO>();
		if (reports != null && !reports.isEmpty()) {
			for (ReportDisplayData reportDisplayData : reports) {
				ReportDTO reportDTO = new ReportDTO();
				reportDTO.setBatch(reportDisplayData.getBatch());
				reportDTO.setDocs(reportDisplayData.getDocs());
				reportDTO.setEntityName(reportDisplayData.getEntityName());
				reportDTOs.add(reportDTO);
				reportDTO.setPages(reportDisplayData.getPages());
			}
		}
		return reportDTOs;
	}

	@Override
	public Integer getTotalRowCount(List<String> batchClassIds, WorkflowType workflowType, Date startDate, Date endDate)
			throws GWTException {
		ReportDataService reportDataService = this.getSingleBeanOfType(ReportDataService.class);
		Integer totalRC = 0;
		try {
			totalRC = reportDataService.getReportTotalRowCountByWorkflow(batchClassIds, workflowType, endDate, startDate);
		} catch (DCMAException dcmae) {
			throw new GWTException("Exception while Getting Total Row Count for Workflows." + dcmae);
		}
		return totalRC;
	}

	@Override
	public Integer getTotalRowCountForUser(List<String> batchClassIds, String user, Date startDate, Date endDate) throws GWTException {
		ReportDataService reportDataService = this.getSingleBeanOfType(ReportDataService.class);
		Integer totalRC = 0;
		try {
			totalRC = reportDataService.getReportTotalRowCountByUser(batchClassIds, user, endDate, startDate);
		} catch (DCMAException dcmae) {
			throw new GWTException("Exception while Getting Total Row Count for Users." + dcmae);
		}
		return totalRC;
	}

	@Override
	public void syncDatabase() throws GWTException {
		ApplicationConfigProperties app = new ApplicationConfigProperties();
		InputStreamReader inputStreamReader = null;
		BufferedReader input = null;
		try {
			String antPath = app.getProperty("report.ant.buildfile.path");
			String commandStr = "";
			if (OSUtil.isWindows()) {
				commandStr = "cmd /c";
			}
			commandStr = commandStr + " ant manual-report-generator -f " + antPath;
			Process process = Runtime.getRuntime().exec(commandStr, null, new File(System.getenv(ANT_HOME_PATH)));
			inputStreamReader = new InputStreamReader(process.getInputStream());
			input = new BufferedReader(inputStreamReader);
			String line = null;
			do {
				line = input.readLine();
				log.debug(line);
			} while (line != null);
			int exitValue = process.waitFor();
			log.debug("System exited with error code:" + exitValue);
			if (exitValue != 0) {
				log.debug("exitValue for command:" + exitValue);
				log.error("Non-zero exit value for command found. So exiting the application.");
				throw new GWTException("Non-zero exit value for command found. So exiting the application");
			}
		} catch (IOException ioe) {
			ioe.printStackTrace(System.out);
			log.error("Exception while Reading Ant File." + ioe.getMessage(), ioe);
			throw new GWTException("Exception while reading Ant File. " + ioe.getMessage());
		} catch (Exception e) {
			e.printStackTrace(System.out);
			log.error("Exception while Executing Ant Task." + e.getMessage(), e);
			throw new GWTException("Exception while Executing Ant Task." + e.getMessage());
		} finally {
			if (input != null) {
				try {
					input.close();
				} catch (IOException e) {
					log.error(e.getMessage(), e);
				}
			}
			if (inputStreamReader != null) {
				try {
					inputStreamReader.close();
				} catch (IOException e) {
					log.error(e.getMessage(), e);
				}
			}
		}
	}

}
