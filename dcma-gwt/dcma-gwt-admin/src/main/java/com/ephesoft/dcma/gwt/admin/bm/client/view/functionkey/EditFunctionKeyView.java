/********************************************************************************* 
* Ephesoft is a Intelligent Document Capture and Mailroom Automation program 
* developed by Ephesoft, Inc. Copyright (C) 2010-2011 Ephesoft Inc. 
* 
* This program is free software; you can redistribute it and/or modify it under 
* the terms of the GNU Affero General Public License version 3 as published by the 
* Free Software Foundation with the addition of the following permission added 
* to Section 15 as permitted in Section 7(a): FOR ANY PART OF THE COVERED WORK 
* IN WHICH THE COPYRIGHT IS OWNED BY EPHESOFT, EPHESOFT DISCLAIMS THE WARRANTY 
* OF NON INFRINGEMENT OF THIRD PARTY RIGHTS. 
* 
* This program is distributed in the hope that it will be useful, but WITHOUT 
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS 
* FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more 
* details. 
* 
* You should have received a copy of the GNU Affero General Public License along with 
* this program; if not, see http://www.gnu.org/licenses or write to the Free 
* Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 
* 02110-1301 USA. 
* 
* You can contact Ephesoft, Inc. headquarters at 111 Academy Way, 
* Irvine, CA 92617, USA. or at email address info@ephesoft.com. 
* 
* The interactive user interfaces in modified source and object code versions 
* of this program must display Appropriate Legal Notices, as required under 
* Section 5 of the GNU Affero General Public License version 3. 
* 
* In accordance with Section 7(b) of the GNU Affero General Public License version 3, 
* these Appropriate Legal Notices must retain the display of the "Ephesoft" logo. 
* If the display of the logo is not reasonably feasible for 
* technical reasons, the Appropriate Legal Notices must display the words 
* "Powered by Ephesoft". 
********************************************************************************/ 

/********************************************************************************* 
* Ephesoft is a Intelligent Document Capture and Mailroom Automation program 
* developed by Ephesoft, Inc. Copyright (C) 2010-2011 Ephesoft Inc. 
* 
* This program is free software; you can redistribute it and/or modify it under 
* the terms of the GNU Affero General Public License version 3 as published by the 
* Free Software Foundation with the addition of the following permission added 
* to Section 15 as permitted in Section 7(a): FOR ANY PART OF THE COVERED WORK 
* IN WHICH THE COPYRIGHT IS OWNED BY EPHESOFT, EPHESOFT DISCLAIMS THE WARRANTY 
* OF NON INFRINGEMENT OF THIRD PARTY RIGHTS. 
* 
* This program is distributed in the hope that it will be useful, but WITHOUT 
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS 
* FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more 
* details. 
* 
* You should have received a copy of the GNU Affero General Public License along with 
* this program; if not, see http://www.gnu.org/licenses or write to the Free 
* Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 
* 02110-1301 USA. 
* 
* You can contact Ephesoft, Inc. headquarters at 111 Academy Way, 
* Irvine, CA 92617, USA. or at email address info@ephesoft.com. 
* 
* The interactive user interfaces in modified source and object code versions 
* of this program must display Appropriate Legal Notices, as required under 
* Section 5 of the GNU Affero General Public License version 3. 
* 
* In accordance with Section 7(b) of the GNU Affero General Public License version 3, 
* these Appropriate Legal Notices must retain the display of the "Ephesoft" logo. 
* If the display of the logo is not reasonably feasible for 
* technical reasons, the Appropriate Legal Notices must display the words 
* "Powered by Ephesoft". 
********************************************************************************/ 

/********************************************************************************* 
* Ephesoft is a Intelligent Document Capture and Mailroom Automation program 
* developed by Ephesoft, Inc. Copyright (C) 2010-2011 Ephesoft Inc. 
* 
* This program is free software; you can redistribute it and/or modify it under 
* the terms of the GNU Affero General Public License version 3 as published by the 
* Free Software Foundation with the addition of the following permission added 
* to Section 15 as permitted in Section 7(a): FOR ANY PART OF THE COVERED WORK 
* IN WHICH THE COPYRIGHT IS OWNED BY EPHESOFT, EPHESOFT DISCLAIMS THE WARRANTY 
* OF NON INFRINGEMENT OF THIRD PARTY RIGHTS. 
* 
* This program is distributed in the hope that it will be useful, but WITHOUT 
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS 
* FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more 
* details. 
* 
* You should have received a copy of the GNU Affero General Public License along with 
* this program; if not, see http://www.gnu.org/licenses or write to the Free 
* Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 
* 02110-1301 USA. 
* 
* You can contact Ephesoft, Inc. headquarters at 111 Academy Way, 
* Irvine, CA 92617, USA. or at email address info@ephesoft.com. 
* 
* The interactive user interfaces in modified source and object code versions 
* of this program must display Appropriate Legal Notices, as required under 
* Section 5 of the GNU Affero General Public License version 3. 
* 
* In accordance with Section 7(b) of the GNU Affero General Public License version 3, 
* these Appropriate Legal Notices must retain the display of the "Ephesoft" logo. 
* If the display of the logo is not reasonably feasible for 
* technical reasons, the Appropriate Legal Notices must display the words 
* "Powered by Ephesoft". 
********************************************************************************/ 

/********************************************************************************* 
* Ephesoft is a Intelligent Document Capture and Mailroom Automation program 
* developed by Ephesoft, Inc. Copyright (C) 2010-2011 Ephesoft Inc. 
* 
* This program is free software; you can redistribute it and/or modify it under 
* the terms of the GNU Affero General Public License version 3 as published by the 
* Free Software Foundation with the addition of the following permission added 
* to Section 15 as permitted in Section 7(a): FOR ANY PART OF THE COVERED WORK 
* IN WHICH THE COPYRIGHT IS OWNED BY EPHESOFT, EPHESOFT DISCLAIMS THE WARRANTY 
* OF NON INFRINGEMENT OF THIRD PARTY RIGHTS. 
* 
* This program is distributed in the hope that it will be useful, but WITHOUT 
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS 
* FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more 
* details. 
* 
* You should have received a copy of the GNU Affero General Public License along with 
* this program; if not, see http://www.gnu.org/licenses or write to the Free 
* Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 
* 02110-1301 USA. 
* 
* You can contact Ephesoft, Inc. headquarters at 111 Academy Way, 
* Irvine, CA 92617, USA. or at email address info@ephesoft.com. 
* 
* The interactive user interfaces in modified source and object code versions 
* of this program must display Appropriate Legal Notices, as required under 
* Section 5 of the GNU Affero General Public License version 3. 
* 
* In accordance with Section 7(b) of the GNU Affero General Public License version 3, 
* these Appropriate Legal Notices must retain the display of the "Ephesoft" logo. 
* If the display of the logo is not reasonably feasible for 
* technical reasons, the Appropriate Legal Notices must display the words 
* "Powered by Ephesoft". 
********************************************************************************/ 

/********************************************************************************* 
* Ephesoft is a Intelligent Document Capture and Mailroom Automation program 
* developed by Ephesoft, Inc. Copyright (C) 2010-2011 Ephesoft Inc. 
* 
* This program is free software; you can redistribute it and/or modify it under 
* the terms of the GNU Affero General Public License version 3 as published by the 
* Free Software Foundation with the addition of the following permission added 
* to Section 15 as permitted in Section 7(a): FOR ANY PART OF THE COVERED WORK 
* IN WHICH THE COPYRIGHT IS OWNED BY EPHESOFT, EPHESOFT DISCLAIMS THE WARRANTY 
* OF NON INFRINGEMENT OF THIRD PARTY RIGHTS. 
* 
* This program is distributed in the hope that it will be useful, but WITHOUT 
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS 
* FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more 
* details. 
* 
* You should have received a copy of the GNU Affero General Public License along with 
* this program; if not, see http://www.gnu.org/licenses or write to the Free 
* Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 
* 02110-1301 USA. 
* 
* You can contact Ephesoft, Inc. headquarters at 111 Academy Way, 
* Irvine, CA 92617, USA. or at email address info@ephesoft.com. 
* 
* The interactive user interfaces in modified source and object code versions 
* of this program must display Appropriate Legal Notices, as required under 
* Section 5 of the GNU Affero General Public License version 3. 
* 
* In accordance with Section 7(b) of the GNU Affero General Public License version 3, 
* these Appropriate Legal Notices must retain the display of the "Ephesoft" logo. 
* If the display of the logo is not reasonably feasible for 
* technical reasons, the Appropriate Legal Notices must display the words 
* "Powered by Ephesoft". 
********************************************************************************/ 

/********************************************************************************* 
* Ephesoft is a Intelligent Document Capture and Mailroom Automation program 
* developed by Ephesoft, Inc. Copyright (C) 2010-2011 Ephesoft Inc. 
* 
* This program is free software; you can redistribute it and/or modify it under 
* the terms of the GNU Affero General Public License version 3 as published by the 
* Free Software Foundation with the addition of the following permission added 
* to Section 15 as permitted in Section 7(a): FOR ANY PART OF THE COVERED WORK 
* IN WHICH THE COPYRIGHT IS OWNED BY EPHESOFT, EPHESOFT DISCLAIMS THE WARRANTY 
* OF NON INFRINGEMENT OF THIRD PARTY RIGHTS. 
* 
* This program is distributed in the hope that it will be useful, but WITHOUT 
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS 
* FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more 
* details. 
* 
* You should have received a copy of the GNU Affero General Public License along with 
* this program; if not, see http://www.gnu.org/licenses or write to the Free 
* Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 
* 02110-1301 USA. 
* 
* You can contact Ephesoft, Inc. headquarters at 111 Academy Way, 
* Irvine, CA 92617, USA. or at email address info@ephesoft.com. 
* 
* The interactive user interfaces in modified source and object code versions 
* of this program must display Appropriate Legal Notices, as required under 
* Section 5 of the GNU Affero General Public License version 3. 
* 
* In accordance with Section 7(b) of the GNU Affero General Public License version 3, 
* these Appropriate Legal Notices must retain the display of the "Ephesoft" logo. 
* If the display of the logo is not reasonably feasible for 
* technical reasons, the Appropriate Legal Notices must display the words 
* "Powered by Ephesoft". 
********************************************************************************/ 

package com.ephesoft.dcma.gwt.admin.bm.client.view.functionkey;

import java.util.ArrayList;
import java.util.List;

import com.ephesoft.dcma.gwt.admin.bm.client.AdminConstants;
import com.ephesoft.dcma.gwt.admin.bm.client.i18n.BatchClassManagementConstants;
import com.ephesoft.dcma.gwt.admin.bm.client.presenter.functionkey.EditFunctionKeyPresenter;
import com.ephesoft.dcma.gwt.core.client.View;
import com.ephesoft.dcma.gwt.core.client.i18n.LocaleDictionary;
import com.ephesoft.dcma.gwt.core.client.validator.ValidatableWidget;
import com.ephesoft.dcma.gwt.core.shared.ConfirmationDialog;
import com.ephesoft.dcma.gwt.core.shared.ConfirmationDialog.DialogListener;
import com.google.gwt.core.client.GWT;
import com.google.gwt.event.dom.client.ChangeEvent;
import com.google.gwt.event.dom.client.ChangeHandler;
import com.google.gwt.event.dom.client.ClickEvent;
import com.google.gwt.event.dom.client.KeyDownEvent;
import com.google.gwt.event.dom.client.KeyDownHandler;
import com.google.gwt.event.dom.client.KeyUpEvent;
import com.google.gwt.event.dom.client.KeyUpHandler;
import com.google.gwt.event.logical.shared.ValueChangeEvent;
import com.google.gwt.event.logical.shared.ValueChangeHandler;
import com.google.gwt.uibinder.client.UiBinder;
import com.google.gwt.uibinder.client.UiField;
import com.google.gwt.uibinder.client.UiHandler;
import com.google.gwt.user.client.ui.Button;
import com.google.gwt.user.client.ui.Label;
import com.google.gwt.user.client.ui.TextBox;
import com.google.gwt.user.client.ui.VerticalPanel;

public class EditFunctionKeyView extends View<EditFunctionKeyPresenter> {

	interface Binder extends UiBinder<VerticalPanel, EditFunctionKeyView> {
	}

	private static final Binder BINDER = GWT.create(Binder.class);

	@UiField
	protected Label methodNameLabel;
	@UiField
	protected Label methodNameStar;
	@UiField
	protected TextBox methodName;

	@UiField
	protected Label keyNameLabel;
	@UiField
	protected Label keyNameStar;
	@UiField
	protected TextBox keyName;

	@UiField
	protected Label keyWariningLabel;

	@UiField
	protected Label methodDescriptionLabel;
	@UiField
	protected TextBox methodDescription;
	@UiField
	protected Label methodDescriptionStar;

	@UiField
	protected Button saveButton;

	@UiField
	protected Button cancelButton;

	@UiField
	protected VerticalPanel editFunctionKeyViewPanel;

	private ValidatableWidget<TextBox> validateMethodNameTextBox;
	private ValidatableWidget<TextBox> validateMethodDescriptionTextBox;

	private final List<String> allowedKeys = new ArrayList<String>();

	public EditFunctionKeyView() {
		super();
		initWidget(BINDER.createAndBindUi(this));
		validateMethodNameTextBox = new ValidatableWidget<TextBox>(methodName);
		validateMethodNameTextBox.getWidget().addValueChangeHandler(new ValueChangeHandler<String>() {

			@Override
			public void onValueChange(ValueChangeEvent<String> event) {
				validateMethodNameTextBox.toggleValidDateBox();
			}
		});
		validateMethodDescriptionTextBox = new ValidatableWidget<TextBox>(methodDescription);
		validateMethodDescriptionTextBox.getWidget().addValueChangeHandler(new ValueChangeHandler<String>() {

			@Override
			public void onValueChange(ValueChangeEvent<String> event) {
				validateMethodDescriptionTextBox.toggleValidDateBox();
			}
		});
		saveButton.setText(AdminConstants.OK_BUTTON);
		cancelButton.setText(AdminConstants.CANCEL_BUTTON);
		editFunctionKeyViewPanel.setSpacing(5);
		methodNameLabel.setText(LocaleDictionary.get().getConstantValue(BatchClassManagementConstants.FUNCTION_KEY_METHOD_NAME)
				+ AdminConstants.COLON);
		methodDescriptionLabel.setText(LocaleDictionary.get().getConstantValue(
				BatchClassManagementConstants.FUNCTION_KEY_METHOD_DESCRIPTION)
				+ AdminConstants.COLON);
		keyNameLabel.setText(LocaleDictionary.get().getConstantValue(BatchClassManagementConstants.FUNCTION_KEY_KEY_NAME)
				+ AdminConstants.COLON);
		keyWariningLabel.setText(LocaleDictionary.get().getConstantValue(BatchClassManagementConstants.FUNCTION_KEY_KEY_WARNING));
		methodNameStar.setText(AdminConstants.STAR);
		keyNameStar.setText(AdminConstants.STAR);
		methodDescriptionStar.setText(AdminConstants.STAR);
		methodNameStar.setStyleName(AdminConstants.FONT_RED_STYLE);
		keyNameStar.setStyleName(AdminConstants.FONT_RED_STYLE);
		methodDescriptionStar.setStyleName(AdminConstants.FONT_RED_STYLE);
		methodNameLabel.setStyleName(AdminConstants.BOLD_TEXT_STYLE);
		keyNameLabel.setStyleName(AdminConstants.BOLD_TEXT_STYLE);
		keyWariningLabel.setStyleName(AdminConstants.FONT_RED_STYLE);
		methodDescriptionLabel.setStyleName(AdminConstants.BOLD_TEXT_STYLE);
		setAllowedKeys();
		keyName.addKeyDownHandler(new KeyDownHandler() {

			@Override
			public void onKeyDown(KeyDownEvent arg0) {
				switch (arg0.getNativeKeyCode()) {
					case 112:
					case 113:
					case 114:
					case 115:
					case 116:
					case 117:
					case 118:
					case 119:
					case 120:
					case 121:
					case 122:
						arg0.getNativeEvent().preventDefault();
						break;
					default:
						break;
				}
			}
		});

		keyName.addChangeHandler(new ChangeHandler() {

			@Override
			public void onChange(ChangeEvent arg0) {
				if (!keyName.getText().isEmpty()) {
					if (!allowedKeys.contains(keyName.getText().toUpperCase())) {
						showKeyErrorDialog("Only keys from F1 to F11(excluding F5) allowed.");
					} else {
						keyName.setText(keyName.getText().toUpperCase());
						keyName.removeStyleName(AdminConstants.VALIDATION_STYLE);
					}
				} else {
					keyName.addStyleName(AdminConstants.VALIDATION_STYLE);
				}
			}
		});

		keyName.addKeyUpHandler(new KeyUpHandler() {

			@Override
			public void onKeyUp(KeyUpEvent arg0) {
				switch (arg0.getNativeKeyCode()) {
					case 112:
						setKeyName("F1");
						break;
					case 113:
						setKeyName("F2");
						break;
					case 114:
						setKeyName("F3");
						break;
					case 115:
						setKeyName("F4");
						break;
					case 117:
						setKeyName("F6");
						break;
					case 118:
						setKeyName("F7");
						break;
					case 119:
						setKeyName("F8");
						break;
					case 120:
						setKeyName("F9");
						break;
					case 121:
						setKeyName("F10");
						break;
					case 122:
						setKeyName("F11");
						break;
					case 9:
						break;
					case 13:
						setKeyName(null);
						break;
					case 8:
						setKeyName(null);
						break;
					default:
						break;
				}
			}
		});
	}

	public ValidatableWidget<TextBox> getValidateMethodNameTextBox() {
		return validateMethodNameTextBox;
	}

	public void setValidateMethodNameTextBox(ValidatableWidget<TextBox> validateMethodNameTextBox) {
		this.validateMethodNameTextBox = validateMethodNameTextBox;
	}

	public ValidatableWidget<TextBox> getValidateMethodDescriptionTextBox() {
		return validateMethodDescriptionTextBox;
	}

	public void setValidateMethodDescriptionTextBox(ValidatableWidget<TextBox> validateMethodDescriptionTextBox) {
		this.validateMethodDescriptionTextBox = validateMethodDescriptionTextBox;
	}

	private void setAllowedKeys() {
		allowedKeys.add("F1");
		allowedKeys.add("F2");
		allowedKeys.add("F3");
		allowedKeys.add("F4");
		allowedKeys.add("F6");
		allowedKeys.add("F7");
		allowedKeys.add("F8");
		allowedKeys.add("F9");
		allowedKeys.add("F10");
		allowedKeys.add("F11");
	}

	@UiHandler("saveButton")
	void onSaveClicked(ClickEvent clickEvent) {
		if (checkEnteredDetails()) {
			if (!keyName.getText().isEmpty()) {
				if (presenter.checkKeyUsedAlready(keyName.getText())) {
					showKeyErrorDialog("The key is already in use.");
				} else {
					presenter.onSave();
				}
			}
		} else {
			final ConfirmationDialog confirmationDialog = new ConfirmationDialog(true);
			confirmationDialog.center();
			confirmationDialog.setDialogTitle("Incomplete Details");
			confirmationDialog.setMessage("All details are necessary.");
			confirmationDialog.addDialogListener(new DialogListener() {

				@Override
				public void onOkClick() {
					confirmationDialog.hide();
				}

				@Override
				public void onCancelClick() {

				}
			});
			confirmationDialog.center();
			confirmationDialog.show();
			confirmationDialog.okButton.setFocus(true);
		}
	}

	private void showKeyErrorDialog(String errorMessage) {

		final ConfirmationDialog confirmationDialog = new ConfirmationDialog(true);
		confirmationDialog.center();
		confirmationDialog.setDialogTitle("Key Not Allowed");
		confirmationDialog.setMessage(errorMessage);
		confirmationDialog.addDialogListener(new DialogListener() {

			@Override
			public void onOkClick() {
				confirmationDialog.hide();
				keyName.setFocus(true);
			}

			@Override
			public void onCancelClick() {

			}
		});
		confirmationDialog.center();
		confirmationDialog.show();
		confirmationDialog.okButton.setFocus(true);
		setKeyName(null);
	}

	private boolean checkEnteredDetails() {
		if (keyName.getText().isEmpty()) {
			return false;
		}
		if (methodDescription.getText().isEmpty()) {
			return false;
		}
		if (methodName.getText().isEmpty()) {
			return false;
		}
		return true;
	}

	@UiHandler("cancelButton")
	void onCancelClicked(ClickEvent clickEvent) {
		presenter.onCancel();
	}

	public String getMethodName() {
		return this.methodName.getValue();
	}

	public void setMethodName(String name) {
		this.methodName.setValue(name);
	}

	public String getMethodDescription() {
		return this.methodDescription.getValue();
	}

	public void setMethodDescription(String description) {
		this.methodDescription.setValue(description);
	}

	public String getKeyName() {
		return this.keyName.getValue();
	}

	public void setKeyName(String name) {
		if (name == null || (name.isEmpty())) {
			this.keyName.addStyleName(AdminConstants.VALIDATION_STYLE);
		} else {
			this.keyName.removeStyleName(AdminConstants.VALIDATION_STYLE);
		}
		this.keyName.setValue(name);
	}

	public TextBox getMethodNameTextBox() {
		return this.methodName;
	}

	public TextBox getMethodDescriptionTextBox() {
		return methodDescription;
	}

}
